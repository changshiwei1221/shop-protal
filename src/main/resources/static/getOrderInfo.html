<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=9; IE=8; IE=7; IE=EDGE">
	<meta http-equiv="X-UA-Compatible" content="IE=EmulateIE7" />
	<title>结算页</title>

	<link rel="stylesheet" type="text/css" href="/js/shop/css/webbase.css" />
	<link rel="stylesheet" type="text/css" href="/js/shop/css/pages-getOrderInfo.css" />
</head>

<body>
<div id="topDiv"></div>
<!--head-->
<div class="top">
	<div class="py-container">
		<div class="shortcut">
			<ul class="fl">
				<li class="f-item">品优购欢迎您！</li>
				<li class="f-item">请登录　<span><a href="#">免费注册</a></span></li>
			</ul>
			<ul class="fr">
				<li class="f-item">我的订单</li>
				<li class="f-item space"></li>
				<li class="f-item">我的品优购</li>
				<li class="f-item space"></li>
				<li class="f-item">品优购会员</li>
				<li class="f-item space"></li>
				<li class="f-item">企业采购</li>
				<li class="f-item space"></li>
				<li class="f-item">关注品优购</li>
				<li class="f-item space"></li>
				<li class="f-item">客户服务</li>
				<li class="f-item space"></li>
				<li class="f-item">网站导航</li>
			</ul>
		</div>
	</div>
</div>
<div class="cart py-container">
	<!--logoArea-->
	<div class="logoArea">
		<div class="fl logo"><span class="title">结算页</span></div>
		<div class="fr search">
			<form class="sui-form form-inline">
				<div class="input-append">
					<input type="text" type="text" class="input-error input-xxlarge" placeholder="品优购自营" />
					<button class="sui-btn btn-xlarge btn-danger" type="button">搜索</button>
				</div>
			</form>
		</div>
	</div>
	<!--主内容-->
	<div class="checkout py-container">
		<div class="checkout-tit">
			<h4 class="tit-txt">填写并核对订单信息</h4>
		</div>
		<div class="checkout-steps">
			<!--收件人信息-->
			<div class="step-tit">
				<h5>收件人信息<span><a data-toggle="modal" data-target=".edit" data-keyboard="false" class="newadd">新增收货地址</a></span></h5>
			</div>
			<div class="step-cont">
				<div class="addressInfo">
					<ul class="addr-detail">
						<li class="addr-item" id="recipientInfo">



						</li>


					</ul>
					<!--添加地址-->
					<div  tabindex="-1" role="dialog" data-hasfoot="false" class="sui-modal hide fade edit">
						<div class="modal-dialog">
							<div class="modal-content">
								<div class="modal-header">
									<button type="button" data-dismiss="modal" aria-hidden="true" class="sui-close" onclick="formReset()">×</button>
									<h4 id="myModalLabel" class="modal-title">添加收货地址</h4>
								</div>
								<div class="modal-body">
									<form action="" class="sui-form form-horizontal" id="myform">
										<div class="control-group" style="display: none">

											<div class="controls">
												<input type="hidden" id="id">
											</div>
										</div>
										<div class="control-group">
											<label class="control-label">收货人：</label>
											<div class="controls">
												<input type="text" class="input-medium" id="recipientName">
											</div>
										</div>

										<div class="control-group">
											<label class="control-label">详细地址：</label>
											<div class="controls">
												<input type="text" class="input-large" id="recipientArea">
											</div>
										</div>
										<div class="control-group">
											<label class="control-label">联系电话：</label>
											<div class="controls">
												<input type="text" class="input-medium" id="recipientPhone">
											</div>
										</div>
										<div class="control-group">
											<label class="control-label">邮箱：</label>
											<div class="controls">
												<input type="text" class="input-medium" id="recipientEmail">
											</div>
										</div>
										<div class="control-group">
											<label class="control-label">地址别名：</label>
											<div class="controls">
												<input type="text" class="input-medium" id="areaType">
											</div>
											<div class="othername">
												建议填写常用地址：<a href="#" class="sui-btn btn-default">家里</a>　<a href="#" class="sui-btn btn-default">父母家</a>　<a href="#" class="sui-btn btn-default">公司</a>
											</div>
										</div>

									</form>


								</div>
								<div class="modal-footer">
									<button type="button" data-ok="modal" class="sui-btn btn-primary btn-large" onclick="addRecipient()">确定</button>
									<button type="button" data-dismiss="modal" class="sui-btn btn-default btn-large" onclick="formReset()">取消</button>
								</div>
							</div>
						</div>
					</div>
					<!--确认地址-->
				</div>
				<div class="hr"></div>

			</div>
			<div class="hr"></div>
			<!--支付和送货-->
			<div class="payshipInfo">
				<div class="step-tit">
					<h5>支付方式</h5>
				</div>
				<div class="step-cont">
					<ul class="payType">
						<li class="selected" value="1" id="payType">微信付款<span title="点击取消选择"></span></li>
						<li>货到付款<span title="点击取消选择"></span></li>
					</ul>
				</div>
				<div class="hr"></div>
				<div class="step-tit">
					<h5>送货清单</h5>
				</div>
				<div class="step-cont">
					<ul class="send-detail" id="cartInfo">


					</ul>
				</div>
				<div class="hr"></div>
			</div>
			<div class="linkInfo">
				<div class="step-tit">
					<h5>发票信息</h5>
				</div>
				<div class="step-cont">
					<span>普通发票（电子）</span>
					<span>个人</span>
					<span>明细</span>
				</div>
			</div>
			<div class="cardInfo">
				<div class="step-tit">
					<h5>使用优惠/抵用</h5>
				</div>
			</div>
		</div>
	</div>
	<div class="order-summary">
		<div class="static fr">
			<div class="list">
				<span><i class="number" id="num"></i>件商品，总商品金额</span>
				<em class="allprice" id="totolPrice"></em>
			</div>
			<div class="list">
				<span>返现：</span>
				<em class="money">0.00</em>
			</div>
			<div class="list">
				<span>运费：</span>
				<em class="transport">0.00</em>
			</div>
		</div>
	</div>
	<div class="clearfix trade">
		<div class="fc-price">应付金额:　<span class="price" id="sumPrice"></span></div>
		<div class="fc-receiverInfo" id="recipientAreaInfo"></div>
	</div>
	<div class="submit">
		<a class="sui-btn btn-danger btn-xlarge"  onclick="createOrder()">提交订单</a>
	</div>
</div>
<!-- 底部栏位 -->
<!--页面底部-->
<div class="clearfix footer">
	<div class="py-container">
		<div class="footlink">
			<div class="Mod-service">
				<ul class="Mod-Service-list">
					<li class="grid-service-item intro  intro1">

						<i class="serivce-item fl"></i>
						<div class="service-text">
							<h4>正品保障</h4>
							<p>正品保障，提供发票</p>
						</div>

					</li>
					<li class="grid-service-item  intro intro2">

						<i class="serivce-item fl"></i>
						<div class="service-text">
							<h4>正品保障</h4>
							<p>正品保障，提供发票</p>
						</div>

					</li>
					<li class="grid-service-item intro  intro3">

						<i class="serivce-item fl"></i>
						<div class="service-text">
							<h4>正品保障</h4>
							<p>正品保障，提供发票</p>
						</div>

					</li>
					<li class="grid-service-item  intro intro4">

						<i class="serivce-item fl"></i>
						<div class="service-text">
							<h4>正品保障</h4>
							<p>正品保障，提供发票</p>
						</div>

					</li>
					<li class="grid-service-item intro intro5">

						<i class="serivce-item fl"></i>
						<div class="service-text">
							<h4>正品保障</h4>
							<p>正品保障，提供发票</p>
						</div>

					</li>
				</ul>
			</div>
			<div class="clearfix Mod-list">
				<div class="yui3-g">
					<div class="yui3-u-1-6">
						<h4>购物指南</h4>
						<ul class="unstyled">
							<li>购物流程</li>
							<li>会员介绍</li>
							<li>生活旅行/团购</li>
							<li>常见问题</li>
							<li>购物指南</li>
						</ul>

					</div>
					<div class="yui3-u-1-6">
						<h4>配送方式</h4>
						<ul class="unstyled">
							<li>上门自提</li>
							<li>211限时达</li>
							<li>配送服务查询</li>
							<li>配送费收取标准</li>
							<li>海外配送</li>
						</ul>
					</div>
					<div class="yui3-u-1-6">
						<h4>支付方式</h4>
						<ul class="unstyled">
							<li>货到付款</li>
							<li>在线支付</li>
							<li>分期付款</li>
							<li>邮局汇款</li>
							<li>公司转账</li>
						</ul>
					</div>
					<div class="yui3-u-1-6">
						<h4>售后服务</h4>
						<ul class="unstyled">
							<li>售后政策</li>
							<li>价格保护</li>
							<li>退款说明</li>
							<li>返修/退换货</li>
							<li>取消订单</li>
						</ul>
					</div>
					<div class="yui3-u-1-6">
						<h4>特色服务</h4>
						<ul class="unstyled">
							<li>夺宝岛</li>
							<li>DIY装机</li>
							<li>延保服务</li>
							<li>品优购E卡</li>
							<li>品优购通信</li>
						</ul>
					</div>
					<div class="yui3-u-1-6">
					</div>
				</div>
			</div>
			<div class="Mod-copyright">
				<ul class="helpLink">
					<li>关于我们<span class="space"></span></li>
					<li>联系我们<span class="space"></span></li>
					<li>关于我们<span class="space"></span></li>
					<li>商家入驻<span class="space"></span></li>
					<li>营销中心<span class="space"></span></li>
					<li>友情链接<span class="space"></span></li>
					<li>关于我们<span class="space"></span></li>
					<li>营销中心<span class="space"></span></li>
					<li>友情链接<span class="space"></span></li>
					<li>关于我们</li>
				</ul>
			</div>
		</div>
	</div>
</div>
<!--页面底部END-->

<textarea style="display: none" id="recipientInfoDiv">
		<div>
								<div class="con name " id="selected_##id##"  onclick="selected('##id##')"><a href="javascript:;" >##recipientName##<span title="点击取消选择">&nbsp;</a></div>
								<div class="con address address-hover">##recipientName## ##recipientArea## <span>##recipientPhone##</span>
									<span class="base" id="defult_##id##">默认地址</span>
									<span class="edittext"><a data-toggle="modal" data-target=".edit" data-keyboard="false" onclick="recipientOne('##id##')">编辑</a>&nbsp;&nbsp;<a href="javascript:;" onclick="delRecipient('##id##')">删除</a></span>
								</div>
								<div class="clearfix"></div>
							</div>
</textarea>
<textarea style="display:none" id="cartInfoDiv">
		<li>

							<div class="sendGoods">

								<ul class="yui3-g">
									<li class="yui3-u-1-6">
										<span><img src="##imgUrl##"/></span>
									</li>
									<li class="yui3-u-7-12">
										<div class="desc" style="text-align: center">##productName##</div>
										<div class="seven" style="text-align: center">7天无理由退货</div>
									</li>
									<li class="yui3-u-1-12">
										<div class="price">￥##price##</div>
									</li>
									<li class="yui3-u-1-12">
										<div class="num">##num##</div>
									</li>
									<li class="yui3-u-1-12">
										<div class="exit">有货</div>
									</li>
								</ul>
							</div>
						</li>
</textarea>
<script type="text/javascript" src="/js/jquery-3.3.1.min.js"></script>
<script type="text/javascript" src="js/jquery.cookie.min.js"></script>
<!--
<script type="text/javascript" src="/js/shop/js/plugins/jquery/jquery.min.js"></script>
-->
<script type="text/javascript" src="/js/shop/js/plugins/jquery.easing/jquery.easing.min.js"></script>
<script type="text/javascript" src="/js/shop/js/plugins/sui/sui.min.js"></script>
<!--
<script type="text/javascript" src="/js/shop/components/ui-modules/nav/nav-portal-top.js"></script>
-->
<script type="text/javascript" src="/js/shop/js/pages/getOrderInfo.js"></script>
</body>
<script>
    $.ajaxSetup({
        beforeSend:function(xhr){
            var   fh_token= $.cookie("token")
            xhr.setRequestHeader("token",fh_token);
            xhr.setRequestHeader("x-token",v_token);
        },

    })

    $(function () {
        getTonkenInfo();
        recipientInfo();
        cartInfo();
    })

	var v_token;
	function getTonkenInfo() {
        var token= $.cookie("token")
        if(token) {
            $.ajax({
                type: 'get',
                url: 'http://localhost:8081/tokens/getTonken',
                success: function (result) {
                    if (result.code == 200) {
                        v_token=result.data;
                        }
                    }
            })
        }
    }

    function cartInfo() {
        var token= $.cookie("token")
        if(token){
            $.ajax({
                type:'get',
                url:'http://localhost:8081/carts/cartList',
                success:function (result) {
                    if (result.code==200){
                        if(result.data!=null){
                            itemList=result.data.itemList;
                            var cartBody='';
                            for (let list of itemList) {
                                cartBody+= $("#cartInfoDiv").val().replace(/##imgUrl##/g,list.imgUrl)
                                    .replace(/##num##/g,list.num)
                                    .replace(/##productName##/g,list.productName)
                                    .replace(/##price##/g,list.price)
                                $("#cartInfo").html(cartBody)
                            }
                            $("#num").html(result.data.totalNum)
                            $("#totolPrice").html("¥"+result.data.totalPrice)
                            $("#sumPrice").html("¥"+result.data.totalPrice)
                        }else {
                            $("#cartInfo").html("<h1 style='text-align: center'>购物车为空,请<a href='index.html'>购买</a>商品！</h1>")
                        }
                    }
                }
            })
        }else {
            $("#cartInfo").html("<h1 style='text-align: center'>请先<a href='login.html'>登录</a>！</h1>")
        }

    }
    var  recipientList;
   var recipientIdList=[];
    var  idOne;
	function recipientInfo() {
        var token= $.cookie("token")
        if(token){
            $.ajax({
                type:'get',
                url:'http://localhost:8081/recipients/recipientList',
                success:function (result) {
                    if (result.code==200){
                        if(result.data!=null){
                             recipientList=result.data;
                            var orderInfo='';
                            for (let list of recipientList) {
                                orderInfo+= $("#recipientInfoDiv").val()
									.replace(/##recipientName##/g,list.recipientName)
									.replace(/##id##/g,list.id)
                                    .replace(/##recipientPhone##/g,list.recipientPhone)
                                    .replace(/##recipientArea##/g,list.recipientArea)
                            }
                            $("#recipientInfo").html(orderInfo)
                            for (let list of recipientList) {
                                recipientIdList.push(list.id);
								if (list.deflutArea==0){
								    $("#defult_"+list.id).remove();
								}
								if (list.deflutArea==1){
                                    idOne=list.id;
								    $("#selected_"+list.id).addClass("selected");
                                    $("#recipientAreaInfo").html("寄送至:"+list.recipientArea+"收货人："+list.recipientName+ list.recipientPhone);

                                }

                            }
                        }else {
                            $("#recipientInfo").html("<h1>请先添加收货信息！</h1>")
                        }
                    }
                }
            })
        }else {
            $("#recipientInfo").html("<h1 style='text-align: center'>请先<a href='login.html'>登录</a>！</h1>")
        }

    }


    function addRecipient() {
        var token= $.cookie("token")
        if(token){

            var recipient={};
         var   id= $("#id").val();
         var   recipientName= $("#recipientName").val();
         var   recipientPhone= $("#recipientPhone").val();
         var   recipientArea= $("#recipientArea").val();
         var   recipientEmail= $("#recipientEmail").val();
         var   areaType= $("#areaType").val();
            recipient.recipientName=recipientName;
            recipient.recipientPhone=recipientPhone;
            recipient.recipientArea=recipientArea;
            recipient.recipientEmail=recipientEmail;
            recipient.areaType=areaType;
            recipient.id=id;
            $.ajax({
                type:'post',
                url:'http://localhost:8081/recipients/addRecipient',
                data:recipient,
                success:function (result) {
                    if (result.code==200){
                        $("#myform")[0].reset();
                        recipientInfo();

                    }
                }
            })
        }
	}

	function delRecipient(id) {
        var token= $.cookie("token")
        if(token){
            $.ajax({
                type:'delete',
                url:'http://localhost:8081/recipients/'+id,
                success:function (result) {
                    if (result.code==200){
                        recipientInfo();
                    }
                }
            })
        }
    }

    function recipientOne(id) {
        var token= $.cookie("token")
        if(token){
            $.ajax({
                type:'get',
                url:'http://localhost:8081/recipients/recipientOne?id='+id,
                success:function (result) {
                    if (result.code==200){
                        var data=result.data;
                        var   id= data.id;
                        $("#id").val(id);
                        var   recipientName= data.recipientName;
                        $("#recipientName").val(recipientName);
                        var   recipientPhone= data.recipientPhone;
                        $("#recipientPhone").val(recipientPhone);
                        var   recipientArea=data.recipientArea;
                        $("#recipientArea").val(recipientArea);
                        var   recipientEmail=data.recipientEmail;
                        $("#recipientEmail").val(recipientEmail);
                        var   areaType= data.areaType;
                        $("#areaType").val(areaType);
                    }
                }
            })
        }
    }

    function formReset() {
        $("#id").val(null);
        $("#myform")[0].reset();
        recipientInfo();
    }


   function createOrder(){
      var payType= $("#payType").val();
       var token= $.cookie("token")
       if(token){
           $.ajax({
               type:'post',
               url:'http://localhost:8081/orders/createOrder',
			   data:{"recipientId":idOne,"payType":payType},
               success:function (result) {
                   if (result.code==200){
                       orderStockRedis() ;
                   }
               }
           })
       }
   }

   function orderStockRedis() {
       var token= $.cookie("token")
       if(token){
           $.ajax({
               type:'get',
               url:'http://localhost:8081/orders/orderRedis',
               success:function (result) {
                   if (result.code==200){
						location.href="pay.html"
                   }else if (result.code==2003) {
                       location.href="orderFail.html"
                   }else if (result.code==2005) {
                       setTimeout(orderStockRedis(),200)
                       $("#topDiv").html("<h1 style='color: #d43f3a;text-align: center'>订单正在排队处理请稍后！</h1>")
                   }
               },
           })
	   }
   }


    function selected(id) {
        $("#selected_"+idOne).removeClass("selected")
        for (let list of recipientList) {
            if (list.id==id){
                idOne=list.id
                $("#selected_"+list.id).addClass('selected')
                $("#recipientAreaInfo").html("寄送至:"+list.recipientArea+"收货人："+list.recipientName+ list.recipientPhone);
            }
        }

        /*   if($('#selected_'+id).hasClass('selected')) {
               $('#selected_'+id).removeClass('selected') // id为1
           } else {
               $('#selected_'+id).addClass('selected') // id为2
           }*/

    }

</script>
</html>